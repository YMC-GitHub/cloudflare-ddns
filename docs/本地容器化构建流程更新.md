æˆ‘æ¥åœ¨ç°æœ‰ Dockerfile çš„åŸºç¡€ä¸Šæ·»åŠ æœ¬åœ°å¼€å‘é˜¶æ®µï¼Œä¿æŒå…¶ä»–é˜¶æ®µä¸å˜ï¼š

```dockerfile
# =============================================
# å¤šé˜¶æ®µæ„å»ºï¼šæ„å»º + å‘å¸ƒåˆ° GitHub Container Registry
# =============================================

# åŸºç¡€æ„å»ºå‚æ•°
ARG USE_CHINA_MIRROR=false
ARG ALPINE_MIRROR=mirrors.aliyun.com
ARG RUST_MIRROR=tuna

# =============================================
# é˜¶æ®µ1: æœ¬åœ°å¼€å‘ç¯å¢ƒ
# =============================================
FROM rust:1.90-alpine3.20 AS development

# ç»§æ‰¿æ„å»ºå‚æ•°
ARG USE_CHINA_MIRROR
ARG ALPINE_MIRROR
ARG RUST_MIRROR

# æ¡ä»¶æ€§é…ç½®é•œåƒæº
RUN if [ "$USE_CHINA_MIRROR" = "true" ]; then \
        echo "ğŸ”§ Using China mirror: $ALPINE_MIRROR" && \
        sed -i "s|dl-cdn.alpinelinux.org|$ALPINE_MIRROR|g" /etc/apk/repositories; \
    else \
        echo "ğŸŒ Using default Alpine sources"; \
    fi

# å®‰è£…å¼€å‘å·¥å…·å’Œä¾èµ–
RUN apk update && apk add --no-cache \
    git \
    gcc \
    musl-dev \
    openssl-dev \
    build-base \
    pkgconfig \
    openssl-libs-static \
    bash \
    curl \
    vim \
    htop \
    file

WORKDIR /app

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY Cargo.toml ./

# æ¡ä»¶æ€§é…ç½® Cargo å›½å†…æº
RUN if [ "$USE_CHINA_MIRROR" = "true" ]; then \
        echo "ğŸ”§ Configuring Cargo China mirror: $RUST_MIRROR" && \
        mkdir -p /usr/local/cargo/ && \
        case "$RUST_MIRROR" in \
            "tuna") \
                cat > /usr/local/cargo/config << 'EOF' \
[source.crates-io]
replace-with = 'tuna'

[source.tuna]
registry = "https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git"

[net]
git-fetch-with-cli = true
EOF
                ;; \
            "ustc") \
                cat > /usr/local/cargo/config << 'EOF' \
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index/"

[net]
git-fetch-with-cli = true
EOF
                ;; \
        esac && \
        echo "âœ… Cargo mirror configured: $RUST_MIRROR"; \
    else \
        echo "ğŸŒ Using default Cargo sources"; \
        # è®¾ç½® git-fetch-with-cli ä»¥æé«˜ç¨³å®šæ€§ \
        mkdir -p /usr/local/cargo/ && \
        cat > /usr/local/cargo/config << 'EOF' \
[net]
git-fetch-with-cli = true
EOF
    fi

# å®‰è£…å¼€å‘å·¥å…·
RUN cargo install cargo-watch cargo-edit

# é¢„ä¸‹è½½ä¾èµ–
RUN cargo fetch

# å¤åˆ¶æºä»£ç 
COPY src/ src/

# å¼€å‘ç¯å¢ƒé…ç½®
ENV RUST_LOG=debug
ENV RUST_BACKTRACE=1

# å¼€å‘ç¯å¢ƒé»˜è®¤å‘½ä»¤
CMD ["cargo", "watch", "-x", "run", "-x", "test"]

# =============================================
# é˜¶æ®µ2: æ„å»ºé˜¶æ®µï¼ˆä¿æŒåŸæœ‰ä¸å˜ï¼‰
# =============================================
FROM rust:1.90-alpine3.20 AS builder

# ç»§æ‰¿æ„å»ºå‚æ•°
ARG USE_CHINA_MIRROR
ARG ALPINE_MIRROR
ARG RUST_MIRROR

# æ¡ä»¶æ€§é…ç½®é•œåƒæº
RUN if [ "$USE_CHINA_MIRROR" = "true" ]; then \
        echo "ğŸ”§ Using China mirror: $ALPINE_MIRROR" && \
        sed -i "s|dl-cdn.alpinelinux.org|$ALPINE_MIRROR|g" /etc/apk/repositories; \
    else \
        echo "ğŸŒ Using default Alpine sources"; \
    fi

# å®‰è£…æ„å»ºä¾èµ–
RUN apk update && apk add --no-cache \
    git \
    gcc \
    musl-dev \
    openssl-dev \
    build-base \
    pkgconfig \
    openssl-libs-static \
    upx \
    file

WORKDIR /app

# åªå¤åˆ¶å¿…è¦çš„é…ç½®
COPY Cargo.toml ./

# æ¡ä»¶æ€§é…ç½® Cargo å›½å†…æº
RUN if [ "$USE_CHINA_MIRROR" = "true" ]; then \
        echo "ğŸ”§ Configuring Cargo China mirror: $RUST_MIRROR" && \
        mkdir -p /usr/local/cargo/ && \
        case "$RUST_MIRROR" in \
            "tuna") \
                cat > /usr/local/cargo/config << 'EOF' \
[source.crates-io]
replace-with = 'tuna'

[source.tuna]
registry = "https://mirrors.tuna.tsinghua.edu.cn/git/crates.io-index.git"

[net]
git-fetch-with-cli = true
EOF
                ;; \
            "ustc") \
                cat > /usr/local/cargo/config << 'EOF' \
[source.crates-io]
replace-with = 'ustc'

[source.ustc]
registry = "https://mirrors.ustc.edu.cn/crates.io-index/"

[net]
git-fetch-with-cli = true
EOF
                ;; \
        esac && \
        echo "âœ… Cargo mirror configured: $RUST_MIRROR"; \
    else \
        echo "ğŸŒ Using default Cargo sources"; \
        # è®¾ç½® git-fetch-with-cli ä»¥æé«˜ç¨³å®šæ€§ \
        mkdir -p /usr/local/cargo/ && \
        cat > /usr/local/cargo/config << 'EOF' \
[net]
git-fetch-with-cli = true
EOF
    fi

# åˆ›å»ºå‡çš„ src ç›®å½•æ¥ç¼“å­˜ä¾èµ–
RUN mkdir -p src && \
    echo "fn main() {}" > src/main.rs && \
    echo "// dummy lib" > src/lib.rs

# æ„å»ºä¾èµ–ï¼ˆç¼“å­˜å±‚ï¼‰
RUN cargo fetch

RUN cargo build --release --target x86_64-unknown-linux-musl

# ç°åœ¨å¤åˆ¶çœŸæ­£çš„æºä»£ç 
COPY src/ src/

# çœŸå®æ„å»º
RUN rm -f target/x86_64-unknown-linux-musl/release/deps/cloudflare_ddns-* && \
    cargo build --release --target x86_64-unknown-linux-musl

# ä¼˜åŒ–äºŒè¿›åˆ¶ï¼ˆç§»é™¤è°ƒè¯•ç¬¦å·å¹¶å‹ç¼©ï¼‰
RUN strip target/x86_64-unknown-linux-musl/release/cloudflare-ddns && \
    upx --best --lzma target/x86_64-unknown-linux-musl/release/cloudflare-ddns

# éªŒè¯æ„å»ºç»“æœ
RUN echo "=== Build Verification ===" && \
    ls -lh target/x86_64-unknown-linux-musl/release/cloudflare-ddns && \
    file target/x86_64-unknown-linux-musl/release/cloudflare-ddns && \
    echo "=== Static Link Check ===" && \
    ldd target/x86_64-unknown-linux-musl/release/cloudflare-ddns 2>&1 | head -3

# =============================================
# é˜¶æ®µ3: è¯ä¹¦å‡†å¤‡é˜¶æ®µï¼ˆä¿æŒåŸæœ‰ä¸å˜ï¼‰
# =============================================
FROM alpine:3.20 AS certs

# ç»§æ‰¿æ„å»ºå‚æ•°
ARG USE_CHINA_MIRROR
ARG ALPINE_MIRROR

# æ¡ä»¶æ€§é…ç½®é•œåƒæº
RUN if [ "$USE_CHINA_MIRROR" = "true" ]; then \
        echo "ğŸ”§ Using China mirror in certs stage: $ALPINE_MIRROR" && \
        sed -i "s|dl-cdn.alpinelinux.org|$ALPINE_MIRROR|g" /etc/apk/repositories; \
    fi

# å®‰è£…è¯ä¹¦å’Œæ—¶åŒºæ•°æ®
RUN apk update && apk add --no-cache ca-certificates tzdata && \
    update-ca-certificates

# =============================================
# é˜¶æ®µ4: æœ€ç»ˆè¿è¡Œé•œåƒï¼ˆscratchï¼‰ï¼ˆä¿æŒåŸæœ‰ä¸å˜ï¼‰
# =============================================
FROM scratch AS runtime

# å¤åˆ¶ SSL è¯ä¹¦ï¼ˆå¿…é¡»ï¼Œå› ä¸ºä½ çš„åº”ç”¨éœ€è¦ HTTPSï¼‰
COPY --from=certs /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

# æ—¶åŒºä¿¡æ¯
COPY --from=certs /usr/share/zoneinfo /usr/share/zoneinfo
ENV TZ=Asia/Shanghai

# å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
COPY --from=builder /app/target/x86_64-unknown-linux-musl/release/cloudflare-ddns /app/cloudflare-ddns

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT ["/app/cloudflare-ddns"]
```

## ğŸš€ æœ¬åœ°å¼€å‘ä½¿ç”¨æ–¹æ³•

### 1. æ„å»ºå¼€å‘ç¯å¢ƒ
```bash
# æ„å»ºå¼€å‘é•œåƒ
docker build --target development -t cloudflare-ddns:dev .

# docker build --target development --build-arg USE_CHINA_MIRROR=true -t cloudflare-ddns:dev .

# ä½¿ç”¨å›½å†…é•œåƒæ„å»ºå¼€å‘ç¯å¢ƒ
docker build \
  --target development \
  --build-arg USE_CHINA_MIRROR=true \
  --build-arg ALPINE_MIRROR=mirrors.aliyun.com \
  --build-arg RUST_MIRROR=ustc \
  -t cloudflare-ddns:dev .
```

### 2. è¿è¡Œå¼€å‘å®¹å™¨
```bash
# è¿è¡Œå¼€å‘å®¹å™¨ï¼ˆè‡ªåŠ¨ç›‘è§†æ–‡ä»¶å˜åŒ–ï¼‰
docker run -it --rm \
  -v $(pwd):/app \
  -v cloudflare-ddns-cargo-cache:/usr/local/cargo/registry \
  -v cloudflare-ddns-target-cache:/app/target \
  -p 8080:8080 \
  cloudflare-ddns:dev

# æˆ–è€…è¿›å…¥å¼€å‘å®¹å™¨æ‰‹åŠ¨æ“ä½œ
# uc2
docker run -it --rm -v $(pwd):/app -v cloudflare-ddns-cargo-cache:/usr/local/cargo/registry cloudflare-ddns:dev sh

# uc3
docker run -it --rm -v $(pwd)/src:/app/src -v cloudflare-ddns-cargo-cache:/usr/local/cargo/registry cloudflare-ddns:dev sh

# è¿è¡Œå¼€å‘ç‰ˆæœ¬:
# cargo run -- --show-platform
# cargo run -- --version
# cargo run -- --help

# cargo run -- --config .env.example

# export ENV_FILE=/app/.env.example;echo $ENV_FILE;cargo run 
# export ENV_FILE=.env.example;echo $ENV_FILE;cargo run 
# export ENV_FILE=;echo $ENV_FILE;cargo run  # to fix
# unset ENV_FILE;env;cargo run 

# cargo run -- --show-config
# cargo run -- --config .env.example --show-config
# export ENV_FILE=/app/.env.example;echo $ENV_FILE;cargo run -- --show-config
# export ENV_FILE=.env.example;echo $ENV_FILE;cargo run -- --show-config
# export ENV_FILE=;echo $ENV_FILE;cargo run  -- --show-config
# unset ENV_FILE;env;cargo run  -- --show-config



# test:
# cargo test

# æ„å»ºå‘å¸ƒç‰ˆæœ¬:
# cargo build --release
# cargo build --release --target x86_64-unknown-linux-musl

# è¿è¡Œå‘å¸ƒç‰ˆ:
# ./target/x86_64-unknown-linux-musl/release/cloudflare-ddns --version
# ./target/x86_64-unknown-linux-musl/release/cloudflare-ddns --help
# ./target/x86_64-unknown-linux-musl/release/cloudflare-ddns --show-platform
# ./target/x86_64-unknown-linux-musl/release/cloudflare-ddns --config .env.example

```

### 3. ä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰
åˆ›å»º `docker-compose.dev.yml`ï¼š
```yaml
version: '3.8'

services:
  cloudflare-ddns-dev:
    build:
      context: .
      target: development
      args:
        USE_CHINA_MIRROR: false
        ALPINE_MIRROR: mirrors.aliyun.com
        RUST_MIRROR: tuna
    container_name: cloudflare-ddns-dev
    volumes:
      - .:/app
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/app/target
    environment:
      - RUST_LOG=debug
      - RUST_BACKTRACE=1
    working_dir: /app
    stdin_open: true
    tty: true

volumes:
  cargo-cache:
  target-cache:
```

ä½¿ç”¨ Composeï¼š
```bash
# å¯åŠ¨å¼€å‘ç¯å¢ƒ
docker-compose -f docker-compose.dev.yml up

# åœ¨åå°è¿è¡Œ
docker-compose -f docker-compose.dev.yml up -d

# è¿›å…¥å®¹å™¨
docker-compose -f docker-compose.dev.yml exec cloudflare-ddns-dev sh

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.dev.yml logs -f
```

### 4. å¼€å‘ç¯å¢ƒä¸­çš„å¸¸ç”¨å‘½ä»¤
```bash
# åœ¨è¿è¡Œä¸­çš„å¼€å‘å®¹å™¨ä¸­æ‰§è¡Œ
docker exec -it cloudflare-ddns-dev cargo test
docker exec -it cloudflare-ddns-dev cargo clippy
docker exec -it cloudflare-ddns-dev cargo fmt
docker exec -it cloudflare-ddns-dev cargo add new-dependency
```

### 5. ç”Ÿäº§æ„å»ºï¼ˆä¿æŒä¸å˜ï¼‰
```bash
# æ„å»ºç”Ÿäº§é•œåƒ
docker build --target runtime -t cloudflare-ddns:scratch .

# ä½¿ç”¨å›½å†…é•œåƒæ„å»ºç”Ÿäº§ç‰ˆæœ¬
docker build \
  --target runtime \
  --build-arg USE_CHINA_MIRROR=true \
  -t cloudflare-ddns:scratch .
```

## ğŸ¯ å¼€å‘é˜¶æ®µç‰¹æ€§

- **çƒ­é‡è½½**: ä½¿ç”¨ `cargo watch` è‡ªåŠ¨é‡æ–°ç¼–è¯‘
- **å®Œæ•´å·¥å…·é“¾**: åŒ…å« vim, curl, git ç­‰å¼€å‘å·¥å…·
- **ä¾èµ–ç¼“å­˜**: ä½¿ç”¨ volume ç¼“å­˜ cargo registry å’Œ target
- **è°ƒè¯•æ”¯æŒ**: è®¾ç½® `RUST_LOG=debug` å’Œ `RUST_BACKTRACE=1`
- **ä»£ç åŒæ­¥**: å®æ—¶åŒæ­¥å®¿ä¸»æœºä»£ç åˆ°å®¹å™¨

è¿™æ ·å°±åœ¨ä¸æ”¹å˜åŸæœ‰æ„å»ºé˜¶æ®µçš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†å®Œæ•´çš„æœ¬åœ°å¼€å‘ç¯å¢ƒï¼